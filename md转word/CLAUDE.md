# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Markdown to Word converter tool that uses Pandoc to convert `.md` files to `.docx` (Word) format with custom styling and formatting. It's designed for converting technical documentation with proper support for Chinese fonts, code highlighting, and automatic table of contents.

## Key Features

- **Markdown Preprocessing**: Removes horizontal separator lines (`---`) before conversion
- **Custom Word Templates**: Creates reference templates with Chinese font support (宋体 for body text, Times New Roman for code)
- **Automatic TOC**: Generates table of contents with 3-level depth
- **Code Highlighting**: Applies syntax highlighting with Tango style
- **Font Customization**: Post-processes generated Word documents to ensure consistent font application
- **Batch Processing**: Can convert all `.md` files in a directory at once
- **Image Support**: Properly resolves relative paths to embedded images

## Architecture

The script is organized into functional modules with a clear conversion pipeline:

1. **Input Handling** (`find_md_files`, main): Detects input files via CLI arguments or auto-discovery
2. **Preprocessing** (`preprocess_markdown`): Cleans Markdown before conversion
3. **Template Creation** (`create_reference_docx`): Builds custom Word template with styled paragraphs, headings, code blocks, and TOC entries
4. **Conversion** (`convert_md_to_docx`): Orchestrates Pandoc conversion with resource path resolution
5. **Post-processing** (`apply_chinese_fonts_to_docx`): Fine-tunes fonts in generated Word document and adds complete table borders using `add_table_borders()`
6. **Fallback** (`convert_md_to_docx_simple`): Provides minimal conversion when template creation fails

**Critical Path Dependencies**:
- `Pandoc` must be installed and path correctly configured in `PANDOC_PATH` constant
- `python-docx` library is optional but highly recommended for font customization
- Temporary files are created in the same directory as the input Markdown file to ensure relative image paths resolve correctly

## Running the Script

### Prerequisites

```bash
# Install Pandoc (Windows with conda)
conda install -c conda-forge pandoc

# Install python-docx for font customization (optional but recommended)
pip install python-docx
```

### Basic Usage

```bash
# Convert single file (output filename auto-generated)
python convert.py input.md

# Convert with custom output path
python convert.py input.md output.docx

# Convert all .md files in current directory
python convert.py

# List Markdown files in current directory
python convert.py --list

# Show help
python convert.py --help
```

### Configuration

The Pandoc executable path is hardcoded in the script:
```python
PANDOC_PATH = r'S:\Tools\Miniconda\envs\pandoc\Library\bin\pandoc.exe'
```

Update this path if Pandoc is installed in a different location.

## Important Implementation Details

### Font Configuration

The script applies fonts in this order:
- **正文 (Body)**: 宋体 (SimSun)
- **标题 (Headings)**: 宋体 with bold, black, non-italic
- **代码 (Code)**: Times New Roman
- **目录 (TOC)**: Times New Roman, 五号 (10.5pt), 1.0 line spacing
- **表格 (Tables)**: 宋体

This is handled in three places:
1. `create_reference_docx()`: Styles the reference template before conversion
2. `apply_chinese_fonts_to_docx()`: Post-processes the generated Word file
3. Fallback fonts applied during Pandoc conversion

### Table Border Configuration

Tables generated by Pandoc may have incomplete borders. The `add_table_borders()` function adds complete borders to all tables:
- Outer borders (top, bottom, left, right)
- Inner borders (horizontal and vertical lines between cells)
- Border style: Single line, 1.5pt weight, black color

This ensures tables display with full grid lines in Word.

### Temporary File Management

- A `_temp_processed.md` file is created in the input directory during conversion
- Reference template `reference_template.docx` is created but cleaned up after use
- All temporary files are cleaned up in `finally` blocks to ensure cleanup on errors

### Image Path Resolution

The script sets working directory to the input file's directory and uses `--resource-path` to ensure relative image paths in Markdown resolve correctly.

## Troubleshooting

**Pandoc not found error**:
- Verify Pandoc is installed: `where pandoc` or `which pandoc`
- Update `PANDOC_PATH` in the script to match your installation

**Font issues in generated Word files**:
- Ensure `python-docx` is installed: `pip install python-docx`
- The script has a fallback that works without python-docx but won't apply custom fonts

**Image not appearing in Word document**:
- Keep images in the same directory or use relative paths
- Images referenced in Markdown must be accessible from the input file's directory

**Encoding issues**:
- Input files are read as UTF-8
- Ensure `.md` files are saved with UTF-8 encoding

## Testing

To test the converter manually:
```bash
# Create a test markdown file with images and code blocks
python convert.py test.md

# Verify the output Word file opens correctly
# Check fonts: Ctrl+A in Word to select all and verify formatting
```

## Dependencies

- **Pandoc** (required): Document converter
- **python-docx** (optional): Python library for manipulating Word documents, used for font customization and template creation
- **Standard Library**: subprocess, os, sys, tempfile, re

## Common Modifications

If you need to:
- Change Pandoc path: Edit `PANDOC_PATH` variable at line 20
- Modify fonts: Update `create_reference_docx()` and `apply_chinese_fonts_to_docx()` functions
- Change TOC depth: Modify `--toc-depth=3` argument in `convert_md_to_docx()`
- Adjust code highlighting: Change `--highlight-style tango` to other options (e.g., 'pygments', 'espresso', 'monochrome')
